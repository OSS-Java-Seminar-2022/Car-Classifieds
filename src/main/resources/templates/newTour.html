<!DOCTYPE html>
<html lang="en" xmlns:th="http://wwww.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="ie=edge" http-equiv="X-UA-Compatible"/>
    <title>
        Login
    </title>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link crossorigin="" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          rel="stylesheet"/>
    <script crossorigin=""
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map {
            width: 600px;
            height: 400px;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="relative container mx-auto p-6">
    <!-- Flex container -->
    <div class="flex items-center justify-between">
        <!-- Logo -->
        <div class="pt-2">
            <a th:href="@{/main}">
                <img alt="marke logo" class="h-10 w-52" th:src="@{img/marke-logo.svg}"/>
            </a>

        </div>

    </div>
</nav>
<div id="map"></div>
<div class="mb-4">
    <label class="block text-gray-700 font-medium mb-2" for="name">Tour name</label>
    <input class="bg-white rounded-lg px-4 block w-full leading-5 text-gray-700 focus:outline-none focus:shadow-outline-blue-500"
           id="name" th:value="${name}" type="text">
</div>
<p class="block text-gray-700 font-medium mb-2 py-4">Pin your start location</p>
<div class="mb-4">
    <label class="block text-gray-700 font-medium mb-2" for="latitude">Latitude</label>
    <input class="bg-white rounded-lg py-2 px-4 block w-full leading-5 text-gray-700 focus:outline-none focus:shadow-outline-blue-500"
           id="latitude" readonly th:value="${latitude}" type="text">
</div>
<div class="mb-4">
    <label class="block text-gray-700 font-medium mb-2" for="longitude">Longitude</label>
    <input class="bg-white rounded-lg py-2 px-4 block w-full leading-5 text-gray-700 focus:outline-none focus:shadow-outline-blue-500"
           id="longitude" readonly th:value="${longitude}" type="text">
</div>
<div class="mb-4">
    <label class="block text-gray-700 font-medium mb-2" for="city">City</label>
    <input class="bg-white rounded-lg py-2 px-4 block w-full leading-5 text-gray-700 focus:outline-none focus:shadow-outline-blue-500"
           id="city" readonly type="text">
</div>
<div class="mb-4">
    <label class="block text-gray-700 font-medium mb-2" for="country">Country</label>
    <input class="bg-white rounded-lg py-2 px-4 block w-full leading-5 text-gray-700 focus:outline-none focus:shadow-outline-blue-500"
           id="country" readonly type="text">
</div>
<button class="flex justify-center bg-transparent hover:bg-blue-500 text-blue-700 font-semibold hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded"
        onclick="tryProceed()" type="submit">
    Test
</button>
<div class="hidden flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800"
     id="toast"
     role="alert">
    <div class="ml-3 text-sm font-normal" id="toastText">...</div>
</div>
</body>
<script>
    let tempTimeoutId;

    function toast(text) {
        setToastText(text);
        showToast(true);
        clearTimeout(tempTimeoutId);
        tempTimeoutId = setTimeout(() => {
            showToast(false);
        }, 5000);
    }

    function showToast(visibility) {
        if (visibility) {
            document.getElementById("toast").style.display = "block";
        } else {
            document.getElementById("toast").style.display = "none";
        }
    }

    function setToastText(text) {
        document.getElementById("toastText").innerText = text;
    }
</script>
<script>
    function showError(text) {
        toast(text);
    }

    function proceed() {
        window.location.href = "/pageCreate";
    }

    async function tryProceed() {
        let allToursResponse = await fetch("http://localhost:8080/tours/getAll");
        if (allToursResponse.ok) {
            let allTours = JSON.parse(await allToursResponse.text());
            let tourNames = allTours.map((e) => e.name);
            if (document.getElementById("name").value && !tourNames.includes(document.getElementById("name").value)) {
                proceed();
            } else {
                showError("Name is empty or already taken!")
            }
        } else {
            showError(await allToursResponse.text());
        }

    }
</script>

<script>
    let map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    let marker = L.marker([0, 0]).addTo(map);
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            marker.setLatLng(pos);
            document.getElementById("latitude").value = pos.lat;
            document.getElementById("longitude").value = pos.lng;
            map.setView(pos, 13);
            getCityCountry(pos.lat, pos.lng);
        });
    }

    function onMapClick(e) {
        marker.setLatLng(e.latlng);
        document.getElementById("latitude").value = e.latlng.lat;
        document.getElementById("longitude").value = e.latlng.lng;
        getCityCountry(e.latlng.lat, e.latlng.lng);
    }

    function getCityCountry(lat, lng) {
        let key = '6d297337290847d097df17106efaecc4';
        let url = 'https://api.opencagedata.com/geocode/v1/json?q=' + lat + '+' + lng + '&key=' + key;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let city = data.results[0].components.city;
                let country = data.results[0].components.country;
                if (city === undefined) {
                    city = null;
                }
                document.getElementById("city").value = city;
                document.getElementById("country").value = country;
            })
            .catch(error => console.log(error));
    }

    map.on('click', onMapClick);
</script>
</html>